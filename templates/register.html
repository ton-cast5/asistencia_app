<!-- templates/register.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Asistencia App</title>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #4cc9f0;
            --success-color: #06d6a0;
            --warning-color: #ffd166;
            --danger-color: #ef476f;
            --dark-color: #2b2d42;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            
            --border-radius-sm: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 1rem;
            --border-radius-xl: 1.5rem;
        }

        /* ===== RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* ===== ANIMACIONES ===== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== CARD PRINCIPAL ===== */
        .register-card {
            background: white;
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
            animation: slideUp 0.5s ease;
        }

        /* ===== HEADER ===== */
        .register-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .register-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .register-header h1 i {
            font-size: 2.5rem;
        }

        .register-header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            padding: 20px 40px 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray-color);
            font-size: 0.9rem;
            transition: all 0.3s;
            flex: 1;
        }

        .step.active {
            color: var(--primary-color);
        }

        .step.completed {
            color: var(--success-color);
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .step.active .step-icon {
            background: var(--primary-color);
            color: white;
            animation: pulse 1s infinite;
        }

        .step.completed .step-icon {
            background: var(--success-color);
            color: white;
        }

        .progress-bar {
            height: 4px;
            background: var(--light-color);
            border-radius: 2px;
            margin: 10px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* ===== FORM ===== */
        .register-form {
            padding: 20px 40px 40px;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95rem;
        }

        .form-group label i {
            color: var(--primary-color);
            margin-right: 5px;
            width: 20px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .form-control.error {
            border-color: var(--danger-color);
        }

        .form-control.success {
            border-color: var(--success-color);
        }

        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group .form-control {
            padding-right: 40px;
        }

        .input-icon {
            position: absolute;
            right: 12px;
            color: var(--gray-color);
            pointer-events: none;
        }

        .input-icon.valid {
            color: var(--success-color);
        }

        .input-icon.invalid {
            color: var(--danger-color);
        }

        /* ===== VALIDATION ===== */
        .validation-feedback {
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .validation-feedback i {
            font-size: 0.9rem;
        }

        .validation-feedback.valid {
            color: var(--success-color);
        }

        .validation-feedback.invalid {
            color: var(--danger-color);
        }

        .password-strength {
            margin-top: 10px;
        }

        .strength-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 5px;
        }

        .strength-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s, background-color 0.3s;
        }

        .strength-text {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        /* ===== CHECKBOX Y RADIO ===== */
        .role-selection {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .role-card {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius-md);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-card:hover {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.05);
        }

        .role-card.selected {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }

        .role-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .role-card h4 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .role-card p {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .role-radio {
            display: none;
        }

        /* ===== TÉRMINOS ===== */
        .terms-group {
            background: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-label a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .checkbox-label a:hover {
            text-decoration: underline;
        }

        /* ===== DEVICE INFO ===== */
        .device-info {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .device-info i {
            color: var(--primary-color);
            margin-right: 10px;
        }

        .device-id {
            font-family: monospace;
            background: white;
            padding: 8px;
            border-radius: var(--border-radius-sm);
            margin-top: 10px;
            border: 1px dashed var(--primary-color);
        }

        /* ===== BOTONES ===== */
        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-link {
            background: none;
            color: var(--gray-color);
        }

        /* ===== LOGIN LINK ===== */
        .login-link {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: white;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast.info {
            border-left: 4px solid var(--secondary-color);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--secondary-color); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--gray-color);
            padding: 0 5px;
        }

        .toast-close:hover {
            color: var(--dark-color);
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .register-card {
                margin: 10px;
            }
            
            .register-header {
                padding: 20px;
            }
            
            .register-form {
                padding: 20px;
            }
            
            .progress-container {
                padding: 20px 20px 0;
            }
            
            .role-selection {
                flex-direction: column;
            }
            
            .toast {
                min-width: auto;
                width: 90%;
                right: 5%;
            }
            
            .step span {
                display: none;
            }
            
            .step-icon {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Procesando registro...</p>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Main Card -->
    <div class="register-card">
        <div class="register-header">
            <h1>
                <i class="fas fa-qrcode"></i>
                Asistencia App
            </h1>
            <p>Regístrate para comenzar a usar el sistema</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-icon">1</div>
                    <span>Cuenta</span>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon">2</div>
                    <span>Datos</span>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">3</div>
                    <span>Verificación</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 33%"></div>
            </div>
        </div>

        <!-- Registration Form -->
        <form class="register-form" id="registerForm" onsubmit="return false;">
            <!-- Step 1: Tipo de cuenta -->
            <div class="form-step active" id="step1-content">
                <h3 style="margin-bottom: 20px; color: var(--dark-color);">
                    <i class="fas fa-user-tie"></i> ¿Qué tipo de usuario eres?
                </h3>

                <div class="role-selection">
                    <label class="role-card" id="roleAlumno">
                        <input type="radio" name="rol" value="alumno" class="role-radio" checked>
                        <i class="fas fa-user-graduate"></i>
                        <h4>Alumno</h4>
                        <p>Regístrate para escanear QR y registrar tu asistencia</p>
                    </label>

                    <label class="role-card" id="roleProfesor">
                        <input type="radio" name="rol" value="profesor" class="role-radio">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <h4>Profesor</h4>
                        <p>Regístrate para generar QR y gestionar asistencias</p>
                    </label>
                </div>

                <div class="device-info">
                    <i class="fas fa-mobile-alt"></i>
                    <strong>Este dispositivo quedará vinculado a tu cuenta</strong>
                    <div class="device-id" id="deviceId">Cargando ID del dispositivo...</div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Continuar <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Datos personales -->
            <div class="form-step" id="step2-content">
                <h3 style="margin-bottom: 20px; color: var(--dark-color);">
                    <i class="fas fa-address-card"></i> Datos personales
                </h3>

                <div class="form-group">
                    <label><i class="fas fa-id-card"></i> Matrícula *</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="matricula" 
                               placeholder="Ej: 112H11111" maxlength="9" required>
                        <span class="input-icon" id="matriculaIcon">
                            <i class="fas fa-id-card"></i>
                        </span>
                    </div>
                    <div class="validation-feedback" id="matriculaFeedback"></div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-user"></i> Nombre completo *</label>
                    <input type="text" class="form-control" id="nombre" 
                           placeholder="Ej: Juan Pérez García" required>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Correo electrónico *</label>
                    <div class="input-group">
                        <input type="email" class="form-control" id="email" 
                               placeholder="correo@ejemplo.com" required>
                        <span class="input-icon" id="emailIcon">
                            <i class="fas fa-envelope"></i>
                        </span>
                    </div>
                    <div class="validation-feedback" id="emailFeedback"></div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Contraseña *</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password" 
                               placeholder="Mínimo 8 caracteres" required>
                        <span class="input-icon" id="passwordIcon">
                            <i class="fas fa-lock"></i>
                        </span>
                    </div>
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="passwordStrength" style="width: 0%"></div>
                        </div>
                        <div class="strength-text" id="passwordStrengthText">Ingresa una contraseña</div>
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Confirmar contraseña *</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="confirmPassword" 
                               placeholder="Repite tu contraseña" required>
                        <span class="input-icon" id="confirmIcon">
                            <i class="fas fa-check"></i>
                        </span>
                    </div>
                    <div class="validation-feedback" id="confirmFeedback"></div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()" id="step2Next">
                        Continuar <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Verificación y términos -->
            <div class="form-step" id="step3-content">
                <h3 style="margin-bottom: 20px; color: var(--dark-color);">
                    <i class="fas fa-check-circle"></i> Verificación final
                </h3>

                <div class="terms-group">
                    <h4 style="margin-bottom: 15px;">Resumen de registro:</h4>
                    
                    <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: var(--border-radius-sm);">
                        <p><strong><i class="fas fa-user-tag"></i> Rol:</strong> <span id="resumenRol">Alumno</span></p>
                        <p><strong><i class="fas fa-id-card"></i> Matrícula:</strong> <span id="resumenMatricula">-</span></p>
                        <p><strong><i class="fas fa-user"></i> Nombre:</strong> <span id="resumenNombre">-</span></p>
                        <p><strong><i class="fas fa-envelope"></i> Email:</strong> <span id="resumenEmail">-</span></p>
                        <p><strong><i class="fas fa-mobile-alt"></i> Dispositivo:</strong> <span id="resumenDevice">-</span></p>
                    </div>

                    <div class="checkbox-label">
                        <input type="checkbox" id="terminos" required>
                        <span>
                            Acepto los 
                            <a href="#" onclick="showTerms()">Términos y Condiciones</a>
                            y la 
                            <a href="#" onclick="showPrivacy()">Política de Privacidad</a>
                        </span>
                    </div>

                    <div class="checkbox-label" style="margin-top: 10px;">
                        <input type="checkbox" id="notificaciones" checked>
                        <span>Deseo recibir notificaciones sobre mis asistencias</span>
                    </div>
                </div>

                <div class="alert" style="background: #e7f3ff; border-left: 4px solid var(--primary-color); padding: 15px; border-radius: var(--border-radius-md); margin-bottom: 20px;">
                    <i class="fas fa-info-circle" style="color: var(--primary-color); margin-right: 10px;"></i>
                    <strong>Importante:</strong> Este dispositivo quedará vinculado permanentemente a tu cuenta. No podrás cambiar de dispositivo sin contactar al administrador.
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    <button type="button" class="btn btn-primary" onclick="registrarUsuario()" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Completar Registro
                    </button>
                </div>
            </div>

            <!-- Login Link -->
            <div class="login-link">
                <a href="/">
                    <i class="fas fa-sign-in-alt"></i>
                    ¿Ya tienes cuenta? Inicia sesión
                </a>
            </div>
        </form>
    </div>

    <!-- Modal de Términos (simplificado) -->
    <div class="modal" id="termsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; border-radius: var(--border-radius-lg); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #e9ecef;">
                <h3>Términos y Condiciones</h3>
            </div>
            <div style="padding: 20px;">
                <p>Al registrarte en Asistencia App, aceptas:</p>
                <ul style="margin-left: 20px;">
                    <li>Proporcionar información veraz y actualizada</li>
                    <li>No compartir tus credenciales de acceso</li>
                    <li>Usar el sistema únicamente para fines académicos</li>
                    <li>La geolocalización será utilizada para validar tu asistencia</li>
                    <li>Tu dispositivo quedará vinculado permanentemente a tu cuenta</li>
                </ul>
            </div>
            <div style="padding: 20px; border-top: 1px solid #e9ecef; text-align: right;">
                <button class="btn btn-primary" onclick="closeTerms()">Entendido</button>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES =====
        let currentStep = 1;
        const totalSteps = 3;
        let deviceId = localStorage.getItem('device_id');

        // ===== INICIALIZACIÓN =====
        document.addEventListener('DOMContentLoaded', function() {
            generarDeviceId();
            setupEventListeners();
            actualizarResumen();
        });

        // ===== GENERAR ID DEL DISPOSITIVO =====
        function generarDeviceId() {
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
                localStorage.setItem('device_id', deviceId);
            }
            document.getElementById('deviceId').innerHTML = `<i class="fas fa-microchip"></i> ${deviceId}`;
            document.getElementById('resumenDevice').textContent = deviceId;
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Radio buttons de rol
            document.querySelectorAll('input[name="rol"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.role-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    if (this.value === 'alumno') {
                        document.getElementById('roleAlumno').classList.add('selected');
                    } else {
                        document.getElementById('roleProfesor').classList.add('selected');
                    }
                    actualizarResumen();
                });
            });

            // Validaciones en tiempo real
            document.getElementById('matricula').addEventListener('input', validarMatricula);
            document.getElementById('email').addEventListener('input', validarEmail);
            document.getElementById('password').addEventListener('input', validarPassword);
            document.getElementById('confirmPassword').addEventListener('input', validarConfirmPassword);

            // Marcar roleAlumno como seleccionado por defecto
            document.getElementById('roleAlumno').classList.add('selected');
        }

        // ===== VALIDACIONES =====
        function validarMatricula() {
            const matricula = document.getElementById('matricula').value.toUpperCase();
            document.getElementById('matricula').value = matricula;
            
            const icon = document.getElementById('matriculaIcon');
            const feedback = document.getElementById('matriculaFeedback');
            
            // Nuevo formato: 8 caracteres alfanuméricos (ej: 232H17024)
            const patron = /^[A-Z0-9]{8}$/;
            
            if (matricula.length === 0) {
                icon.innerHTML = '<i class="fas fa-id-card"></i>';
                feedback.innerHTML = '';
                return false;
            }
            
            if (patron.test(matricula)) {
                icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-check"></i> Matrícula válida';
                feedback.className = 'validation-feedback valid';
                return true;
            } else {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Formato: 8 caracteres (ej: 232H17024)';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
        }

        function validarEmail() {
            const email = document.getElementById('email').value;
            const icon = document.getElementById('emailIcon');
            const feedback = document.getElementById('emailFeedback');
            
            const patron = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email.length === 0) {
                icon.innerHTML = '<i class="fas fa-envelope"></i>';
                feedback.innerHTML = '';
                return false;
            }
            
            if (patron.test(email)) {
                icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-check"></i> Email válido';
                feedback.className = 'validation-feedback valid';
                return true;
            } else {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Email inválido';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
        }

        function validarPassword() {
            const password = document.getElementById('password').value;
            const icon = document.getElementById('passwordIcon');
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('passwordStrengthText');
            
            let fortaleza = 0;
            
            if (password.length === 0) {
                icon.innerHTML = '<i class="fas fa-lock"></i>';
                strengthBar.style.width = '0%';
                strengthBar.style.backgroundColor = '#e9ecef';
                strengthText.innerHTML = 'Ingresa una contraseña';
                return false;
            }
            
            // Verificar longitud
            if (password.length >= 8) fortaleza += 25;
            // Verificar mayúsculas
            if (/[A-Z]/.test(password)) fortaleza += 25;
            // Verificar números
            if (/[0-9]/.test(password)) fortaleza += 25;
            // Verificar caracteres especiales
            if (/[^A-Za-z0-9]/.test(password)) fortaleza += 25;
            
            strengthBar.style.width = fortaleza + '%';
            
            if (fortaleza <= 25) {
                strengthBar.style.backgroundColor = '#ef476f';
                strengthText.innerHTML = 'Contraseña débil';
            } else if (fortaleza <= 50) {
                strengthBar.style.backgroundColor = '#ffd166';
                strengthText.innerHTML = 'Contraseña media';
            } else if (fortaleza <= 75) {
                strengthBar.style.backgroundColor = '#06d6a0';
                strengthText.innerHTML = 'Contraseña buena';
            } else {
                strengthBar.style.backgroundColor = '#4361ee';
                strengthText.innerHTML = 'Contraseña muy segura';
            }
            
            icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
            validarConfirmPassword();
            return fortaleza >= 50;
        }

        function validarConfirmPassword() {
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirmPassword').value;
            const icon = document.getElementById('confirmIcon');
            const feedback = document.getElementById('confirmFeedback');
            
            if (confirm.length === 0) {
                icon.innerHTML = '<i class="fas fa-check"></i>';
                feedback.innerHTML = '';
                return false;
            }
            
            if (password === confirm) {
                icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-check"></i> Las contraseñas coinciden';
                feedback.className = 'validation-feedback valid';
                return true;
            } else {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Las contraseñas no coinciden';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
        }

        // ===== NAVEGACIÓN DE PASOS =====
        function nextStep() {
            if (currentStep === 1) {
                // Paso 1 siempre válido (solo selección de rol)
                currentStep++;
                updateSteps();
            } else if (currentStep === 2) {
                // Validar paso 2
                if (validarPaso2()) {
                    currentStep++;
                    updateSteps();
                    actualizarResumen();
                } else {
                    showToast('error', 'Error', 'Completa todos los campos correctamente');
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateSteps();
            }
        }

        function updateSteps() {
            // Actualizar clases de los steps
            for (let i = 1; i <= totalSteps; i++) {
                const step = document.getElementById(`step${i}`);
                const content = document.getElementById(`step${i}-content`);
                
                if (i < currentStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (i === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
                
                content.classList.toggle('active', i === currentStep);
            }
            
            // Actualizar barra de progreso
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function validarPaso2() {
            const matriculaValida = validarMatricula();
            const nombreValido = document.getElementById('nombre').value.length >= 3;
            const emailValido = validarEmail();
            const passwordValida = validarPassword();
            const confirmValida = validarConfirmPassword();
            
            return matriculaValida && nombreValido && emailValido && passwordValida && confirmValida;
        }

        // ===== ACTUALIZAR RESUMEN =====
        function actualizarResumen() {
            const rol = document.querySelector('input[name="rol"]:checked')?.value || 'alumno';
            document.getElementById('resumenRol').innerHTML = rol === 'alumno' ? 
                '<i class="fas fa-user-graduate"></i> Alumno' : 
                '<i class="fas fa-chalkboard-teacher"></i> Profesor';
            
            document.getElementById('resumenMatricula').textContent = document.getElementById('matricula').value || '-';
            document.getElementById('resumenNombre').textContent = document.getElementById('nombre').value || '-';
            document.getElementById('resumenEmail').textContent = document.getElementById('email').value || '-';
        }

        // ===== REGISTRO CON BACKEND =====
        async function registrarUsuario() {
            if (!document.getElementById('terminos').checked) {
                showToast('warning', 'Acepta términos', 'Debes aceptar los términos y condiciones');
                return;
            }

            const btn = document.getElementById('registerBtn');
            const overlay = document.getElementById('loadingOverlay');
            
            // Mostrar loading
            btn.disabled = true;
            overlay.classList.add('active');
            
            // Recopilar datos
            const userData = {
                matricula: document.getElementById('matricula').value.toUpperCase(),
                nombre: document.getElementById('nombre').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                rol: document.querySelector('input[name="rol"]:checked')?.value || 'alumno',
                telefono_id: deviceId,
                notificaciones: document.getElementById('notificaciones').checked
            };

            try {
                // Petición real al backend
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('success', '¡Registro exitoso!', data.message);
                    
                    // Guardar token si lo necesitas
                    if (data.token) {
                        localStorage.setItem('auth_token', data.token);
                    }
                    
                    // Redirigir según el rol
                    setTimeout(() => {
                        if (userData.rol === 'profesor') {
                            window.location.href = '/dashboard_profesor';
                        } else {
                            window.location.href = '/dashboard_alumno';
                        }
                    }, 1500);
                } else {
                    showToast('error', 'Error', data.message || 'Error al registrar');
                    btn.disabled = false;
                    overlay.classList.remove('active');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('error', 'Error de conexión', 'No se pudo conectar con el servidor');
                btn.disabled = false;
                overlay.classList.remove('active');
            }
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            }[type];
            
            toast.innerHTML = `
                <div class="toast-icon"><i class="fas ${icon}"></i></div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(toast);
            
            // Auto eliminar después de 5 segundos
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // ===== MODALES =====
        function showTerms() {
            document.getElementById('termsModal').style.display = 'flex';
        }

        function closeTerms() {
            document.getElementById('termsModal').style.display = 'none';
        }

        function showPrivacy() {
            alert('Política de Privacidad: Tus datos serán utilizados solo para fines académicos.');
        }

        // ===== VALIDACIÓN CONTRA BACKEND =====
        async function checkEmailExists(email) {
            if (!email) return false;
            
            try {
                const response = await fetch('/api/check-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                const data = await response.json();
                return data.exists;
            } catch (error) {
                console.error('Error checking email:', error);
                return false;
            }
        }

        async function checkMatriculaExists(matricula) {
            if (!matricula) return false;
            
            try {
                const response = await fetch('/api/check-matricula', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ matricula: matricula })
                });
                const data = await response.json();
                return data.exists;
            } catch (error) {
                console.error('Error checking matricula:', error);
                return false;
            }
        }

        // Modificar validarEmail para verificar existencia
        async function validarEmail() {
            const email = document.getElementById('email').value;
            const icon = document.getElementById('emailIcon');
            const feedback = document.getElementById('emailFeedback');
            
            const patron = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email.length === 0) {
                icon.innerHTML = '<i class="fas fa-envelope"></i>';
                feedback.innerHTML = '';
                return false;
            }
            
            if (!patron.test(email)) {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Email inválido';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
            
            // Verificar si ya existe
            const exists = await checkEmailExists(email);
            if (exists) {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Este email ya está registrado';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
            
            icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
            feedback.innerHTML = '<i class="fas fa-check"></i> Email disponible';
            feedback.className = 'validation-feedback valid';
            return true;
        }

        // Modificar validarMatricula para nuevo formato
        async function validarMatricula() {
            const matricula = document.getElementById('matricula').value.toUpperCase();
            document.getElementById('matricula').value = matricula;
            
            const icon = document.getElementById('matriculaIcon');
            const feedback = document.getElementById('matriculaFeedback');
            
            // Nuevo formato: 8 caracteres alfanuméricos
            const patron = /^[A-Z0-9]{8}$/;
            
            if (matricula.length === 0) {
                icon.innerHTML = '<i class="fas fa-id-card"></i>';
                feedback.innerHTML = '';
                return false;
            }
            
            if (!patron.test(matricula)) {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Formato: 8 caracteres (ej: 232H17024)';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
            
            // Verificar si ya existe
            const exists = await checkMatriculaExists(matricula);
            if (exists) {
                icon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--danger-color);"></i>';
                feedback.innerHTML = '<i class="fas fa-times"></i> Esta matrícula ya está registrada';
                feedback.className = 'validation-feedback invalid';
                return false;
            }
            
            icon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
            feedback.innerHTML = '<i class="fas fa-check"></i> Matrícula disponible';
            feedback.className = 'validation-feedback valid';
            return true;
        }
    </script>
</body>
</html>